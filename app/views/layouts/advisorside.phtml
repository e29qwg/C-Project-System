<?php
$auth = $this->session->get('auth');
$user_id = $auth['id'];
$projectMaps = ProjectMap::find("user_id='$user_id' AND map_type='advisor'");

$semesters = Semester::find();
$allSemesters = array();

foreach ($semesters as $semester)
{
    $allSemesters[$semester->semester_id] = $semester->semester_term . '/' . $semester->semester_year;
}

$this->view->setVar('allSemesters', $allSemesters);
?>

<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="<?= $this->url->get('index'); ?>">CoE-Project</a>
        </div>
        <div class="navbar-collapse collapse">
            <?php echo $this->elements->getMenu(); ?>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-sm-3">
            <div class="list-group">
                <?php
                $userCurrentSemester = UserCurrentSemester::findfirst(array(
                    "conditions" => "user_id=:user_id:",
                    "bind" => array("user_id" => $user_id)
                ));

                if (!$userCurrentSemester)
                {
                    $lCurrentSemester = Settings::findFirst("name='current_semester'");
                    if (!$lCurrentSemester)
                        return $this->settingError();
                    $lCurrentSemester = $lCurrentSemester->value;
                }
                else
                    $lCurrentSemester = $userCurrentSemester->semester_id;

                $this->tag->setDefault('lsemester', $lCurrentSemester);

                echo $this->tag->selectStatic(array(
                    'lsemester',
                    $allSemesters,
                    'required' => 'required',
                    'class' => 'form-control'
                ));

                ?>
            </div>

            <script>
                $(document).ready(function() {
                    $("#lsemester").change(function()
                    {
                        var semester_id = $("#lsemester").val();
                        $.get('<?= $this->url->get('userSettings/setSemester/'); ?>' + semester_id, function() {
                            location.replace('<?= $this->url->get() ?>');
                        })
                    });
                });
            </script>

            <div class="list-group">
                <a href="#" class="list-group-item active">
                    Prepare Project
                    <span class="badge"><?php echo countProjects($projectMaps, '1', $lCurrentSemester); ?></span>
                </a>
                <?php
                showProject($projectMaps, '1', $this,$lCurrentSemester);
                ?>
                <a href="#" class="list-group-item active">
                    Project I
                    <span class="badge"><?php echo countProjects($projectMaps, '2', $lCurrentSemester); ?></span>
                </a>
                <?php
                showProject($projectMaps, '2', $this, $lCurrentSemester);
                ?>
                <a href="#" class="list-group-item active">
                    Project II
                    <span class="badge"><?php echo countProjects($projectMaps, '3', $lCurrentSemester); ?></span>
                </a>
                <?php
                showProject($projectMaps, '3', $this, $lCurrentSemester);
                ?>
            </div>
            <div class="list-group">
                <a href="#" class="list-group-item active">
                    Menu
                </a>
                <a href="<?= $this->url->get(); ?>" class="list-group-item">
                    Home
                </a>
                <a href="<?= $this->url->get('projects/proposed'); ?>" class="list-group-item">
                    Proposed Project
                </a>
            </div>
        </div>
        <div class="col-sm-9">
            <?php echo $this->getContent(); ?>
        </div>
    </div>
</div>

<?php

function countProjects($projectMaps, $level, $currentSemesterId)
{
    $count = 0;

    foreach ($projectMaps as $projectMap)
    {
        $project = Project::findFirst(array(
            "conditions" => "project_id=:project_id: AND project_level_id=:level: AND semester_id=:current_semester:",
            "bind" => array("project_id" => $projectMap->project_id, "project_level_id" => $level, "semester_id" => $currentSemesterId)
        ));

        if ($project)
        {
            $count++;
        }
    }

    return $count;
}

function getNewProgress($projectId)
{
    $progresss = Progress::find("project_id='$projectId'");

    $count = 0;

    foreach ($progresss as $progress)
    {
        $progressEvaluate = ProgressEvaluate::findFirst("progress_id='$progress->progress_id' AND evaluation='0'");

        if ($progressEvaluate)
            $count++;
    }

    return $count;
}

function showProject($projectMaps, $level, $di, $currentSemesterId)
{
    $found = false;
    foreach ($projectMaps as $projectMap)
    {
        $project = Project::findFirst(array(
            "conditions" => "project_id=:project_id: AND project_level_id=:level: AND project_status='Accept' AND semester_id=:semester_id:",
            "bind" => array("project_id" => $projectMap->project_id, "level" => $level, "semester_id" => $currentSemesterId)
        ));

        if ($project)
        {
            $projectMaps = ProjectMap::find("project_id='$project->project_id' AND map_type='owner'");

            $str = "";

            for ($i = 0; $i < count($projectMaps); $i++)
            {
                if ($i != 0)
                    $str += '<br>';
                $tuid = $projectMaps[$i]->user_id;
                $student = User::findFirst("id='$tuid'");
                $str .= $student->title . $student->name;
            }
            ?>
            <a class="list-group-item" href="<?= $di->url->get('progress/evaluate/'); ?><?= $project->project_id ?>"
               data-toggle="tooltip" data-placement="bottom" title="<?= $str; ?>">
                <?= $project->project_name ?>
                <?php
                $newProgresses = getNewProgress($project->project_id);

                if ($newProgresses > 0)
                    echo '<span class="badge">' . $newProgresses . '</span>';
                ?>
            </a>
            <?php
            $found = true;
        }
    }

    if (!$found)
    {
        ?>
        <a class="list-group-item" href="#">ยังไม่ระบุ</a>
    <?php
    }
}

?>

<script>
    $('.list-group-item').tooltip();
</script>

